<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WebAR Gladiador</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="./styles.css">
    
    <!-- The following libraries and polyfills are recommended to maximize browser support -->
    <!-- NOTE: you must adjust the paths as appropriate for your project -->
    
    <!-- ðŸš¨ REQUIRED: Web Components polyfill to support Edge and Firefox < 63 -->
<!--     <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.1.3/webcomponents-loader.js"></script> -->

    <!-- ðŸ’ OPTIONAL: Intersection Observer polyfill for better performance in Safari and IE11 -->
<!--     <script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js"></script> -->

    <!-- ðŸ’ OPTIONAL: Resize Observer polyfill improves resize behavior in non-Chrome browsers -->
<!--     <script src="https://unpkg.com/resize-observer-polyfill@1.5.0/dist/ResizeObserver.js"></script> -->
    
    <!-- ðŸ’ OPTIONAL: The :focus-visible polyfill removes the focus ring for some input types -->
    <script src="https://unpkg.com/focus-visible@5.0.2/dist/focus-visible.js" defer></script>

  </head> 
<body>
  <!--å–ç”¨ç›¸æ©Ÿ(ä¸€å®šè¦httpsä¸‹)-->
  <div id="app"></div>
  <div class="row">
    <div id="card">
      <!-- All you need to put beautiful, interactive 3D content on your site: -->
      <model-viewer src="./assets/yeti-draco-2ue1ep04a1-walk.glb"
                    ios-src="./assets/toy_drummer.usdz"
                    poster="./assets/gladiador.png"
                    alt="A 3D model of an Gladiador"
                    shadow-intensity="1"
                    camera-controls
                    auto-rotate ar
                    touch-action="pan-y"
                    ar-modes="webxr scene-viewer quick-look">
      </model-viewer>
      <!--
      <section class="attribution">
        <span>
          <h1>Gladiador</h1>
          <span>By <a href="https://sketchfab.com/3d-models/gladiador-874fc7e11d674f51a4dc2082d29c9b9a" target="_blank">SketchFab</a></span>
          <br>
          <span>Demo by<a href="https://www.antdevelopers.com" target="_blank">ANT Developers</a></span>
        </span>
        <a class="cc" href="https://creativecommons.org/licenses/by/2.0/" target="_blank">
          <img src="https://mirrors.creativecommons.org/presskit/icons/cc.svg">
          <img src="https://mirrors.creativecommons.org/presskit/icons/by.svg">
        </a>
      </section>
      -->
    </div>
    <div id="btn-ar" style="height:44px; line-height:44px; text-align:center;">é–‹å•Ÿ AR åŠŸèƒ½</div>
  </div>

  <!-- ðŸ’ Include both scripts below to support all browsers! -->

  <!-- Loads <model-viewer> for modern browsers: -->
  <script type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js">
  </script>

  <!-- Loads <model-viewer> for old browsers like IE11: -->
  <script nomodule
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer-legacy.js">
  </script>

  <!--å–ç”¨ç›¸æ©Ÿ(ä¸€å®šè¦httpsä¸‹)-->
  <script>
      const constraints = {
        audio: false,
        video: {
          facingMode: "user"
        }
      };

      const getFrameFromVideo = (video, canvas) => {
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.translate(video.width, 0);
        ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, video.width, video.height);
        ctx.restore();
        requestAnimationFrame(() => getFrameFromVideo(video, canvas));
      };

      const getCameraStream = video => {
        navigator.mediaDevices
          .getUserMedia(constraints)
          .then(function success(stream) {
            video.srcObject = stream;
          });
      };

      const createVideo = (id, width, height) => {
        const video = document.createElement("video");
        video.id = id;
        video.width = width;
        video.height = height;
        video.autoplay = true;
        video.controls = true;
        return video;
      };

      const createCanvas = (id, width, height) => {
        const canvas = document.createElement("canvas");
        canvas.id = id;
        canvas.width = width;
        canvas.height = height;
        return canvas;
      };

      const init = () => {
        const video = createVideo("vid", 0, 0);
        const canvas = createCanvas("canvas", 0, 0);
        const app = document.getElementById("app");
        getCameraStream(video);
        getFrameFromVideo(video, canvas);
        app.appendChild(video);
        app.appendChild(canvas);
        console.log("init");
      };

      document.getElementById("app").onload = init();
  </script>
  
  <!--å¦é–‹ARç•«é¢-->
  <script>
      var liffID = '1657407032-eDyRGJ9k';
      liff.init({
        liffId: liffID
      }).then(function() {
        console.log('LIFF init');

        // é€™é‚Šé–‹å§‹å¯«ä½¿ç”¨å…¶ä»–åŠŸèƒ½
        document.getElementById("btn-ar").onclick = function() {
          liff.openWindow({
            url: location.href + '?ar=1',
            external: true
          });
        }
      }).catch(function(error) {
        console.log(error);
      });
  </script>
</body>
</html>
